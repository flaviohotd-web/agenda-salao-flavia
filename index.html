<script>
  // ================== CONFIG DA API (coloque sua URL aqui) ==================
  const API_URL = "https://script.google.com/macros/s/SEU_ID_DO_WEBAPP/exec";

  // ================== ESTADO GLOBAL ==================
  let appointments = [];
  let currentFilter = "all";

  const form         = document.getElementById("appointment-form");
  const listEl       = document.getElementById("appointments-list");
  const statusFilter = document.getElementById("status-filter");
  const counterEl    = document.getElementById("appointments-counter");

  const params = new URLSearchParams(window.location.search);
  const isAdmin = params.get("admin") === "1";

  document.body.classList.remove("admin", "client");
  document.body.classList.add(isAdmin ? "admin" : "client");

  // ================== API ==================
  async function fetchAppointmentsFromServer() {
    try {
      const url = `${API_URL}?status=${encodeURIComponent(currentFilter)}`;
      const res = await fetch(url);
      const json = await res.json();
      appointments = json.appointments || [];
      renderAppointments();
    } catch (err) {
      console.error("Erro ao buscar agendamentos:", err);
      listEl.innerHTML = `<div class="no-appointments">Erro ao carregar agendamentos.</div>`;
    }
  }

  async function createAppointmentOnServer(apt) {
    const formData = new URLSearchParams();
    formData.append("action", "create");
    formData.append("id", apt.id);
    formData.append("clientName", apt.clientName);
    formData.append("whatsapp", apt.whatsapp);
    formData.append("service", apt.service);
    formData.append("date", apt.date);
    formData.append("time", apt.time);

    await fetch(API_URL, {
      method: "POST",
      body: formData
    });
  }

  async function updateStatusOnServer(id, status) {
    const formData = new URLSearchParams();
    formData.append("action", "updateStatus");
    formData.append("id", id);
    formData.append("status", status);

    await fetch(API_URL, {
      method: "POST",
      body: formData
    });
  }

  // ================== RENDER ==================
  function renderAppointments() {
    if (!listEl || !counterEl) return;

    listEl.innerHTML = "";

    const filtered = appointments.filter((apt) => {
      if (currentFilter === "all") return true;
      return apt.status === currentFilter;
    });

    counterEl.textContent =
      appointments.length === 1
        ? "1 agendamento"
        : `${appointments.length} agendamentos`;

    if (filtered.length === 0) {
      listEl.innerHTML = `<div class="no-appointments">Nenhum agendamento encontrado.</div>`;
      return;
    }

    filtered
      .slice()
      .sort((a, b) => {
        const da = `${a.date} ${a.time}`;
        const db = `${b.date} ${b.time}`;
        return da.localeCompare(db);
      })
      .forEach((apt) => {
        const card = document.createElement("div");
        card.className = "appointment-card";

        const main = document.createElement("div");
        main.className = "appointment-main";

        const title = document.createElement("div");
        title.innerHTML = `<strong>${apt.clientName}</strong>`;

        const service = document.createElement("span");
        service.className = "pill";
        service.textContent = apt.service;

        const info = document.createElement("div");
        info.className = "appointment-meta";
        info.textContent = formatDate(apt.date) + " â€¢ " + apt.time;

        const whatsappInfo = document.createElement("div");
        whatsappInfo.className = "appointment-meta";
        whatsappInfo.textContent = "WhatsApp: " + (apt.whatsapp || "");

        const statusLabel = document.createElement("span");
        statusLabel.className = "status";
        statusLabel.classList.add(
          apt.status === "pending"   ? "status-pending" :
          apt.status === "confirmed" ? "status-confirmed" :
          "status-canceled"
        );
        statusLabel.textContent =
          apt.status === "pending"   ? "Pendente" :
          apt.status === "confirmed" ? "Confirmado" :
          "Cancelado";

        main.appendChild(title);
        main.appendChild(service);
        main.appendChild(info);
        main.appendChild(whatsappInfo);
        main.appendChild(statusLabel);

        const actions = document.createElement("div");
        actions.className = "appointment-actions";

        if (isAdmin) {
          const confirmBtn = document.createElement("button");
          confirmBtn.className = "secondary btn-sm";
          confirmBtn.textContent = "âœ… Confirmar";
          confirmBtn.onclick = () => handleStatusChange(apt, "confirmed");

          const cancelBtn = document.createElement("button");
          cancelBtn.className = "secondary btn-sm";
          cancelBtn.textContent = "âŒ Cancelar";
          cancelBtn.onclick = () => handleStatusChange(apt, "canceled");

          const whatsBtn = document.createElement("button");
          whatsBtn.className = "primary btn-sm";
          whatsBtn.textContent = "ðŸ“² WhatsApp";
          whatsBtn.onclick = () => openWhatsapp(apt);

          actions.appendChild(confirmBtn);
          actions.appendChild(cancelBtn);
          actions.appendChild(whatsBtn);
        } else {
          const info = document.createElement("span");
          info.className = "helper-text";
          info.textContent = "Pedido enviado! A confirmaÃ§Ã£o serÃ¡ via WhatsApp.";
          actions.appendChild(info);
        }

        card.appendChild(main);
        card.appendChild(actions);
        listEl.appendChild(card);
      });
  }

  // ================== UTILITÃRIOS ==================
  function formatDate(isoDate) {
    if (!isoDate) return "";
    const [y, m, d] = isoDate.split("-");
    return `${d}/${m}/${y}`;
  }

  function normalizeWhatsapp(raw) {
    const digits = raw.replace(/\D/g, "");
    return digits.length >= 10 ? digits : null;
  }

  function withinBusinessHours(timeStr) {
    const [h, m] = timeStr.split(":").map(Number);
    const minutes = h * 60 + m;
    return minutes >= 540 && minutes <= 1140; // 09:00 a 19:00
  }

  async function updateStatus(id, status) {
    await updateStatusOnServer(id, status);
    await fetchAppointmentsFromServer();
  }

  async function handleStatusChange(apt, status) {
    await updateStatus(apt.id, status);
    notifyWhatsapp(apt, status);
  }

  function notifyWhatsapp(apt, status) {
    const raw = normalizeWhatsapp(apt.whatsapp);
    if (!raw) {
      alert("WhatsApp invÃ¡lido ou nÃ£o informado.");
      return;
    }

    const statusText = {
      confirmed: "CONFIRMADO âœ…",
      canceled: "CANCELADO âŒ",
      pending: "PENDENTE DE CONFIRMAÃ‡ÃƒO"
    }[status] || status;

    const message = encodeURIComponent(
      `OlÃ¡, ${apt.clientName}!\n\n` +
      `Seu horÃ¡rio para *${apt.service}* em *${formatDate(apt.date)}* Ã s *${apt.time}* foi *${statusText}*.\n\n` +
      `Se precisar, estamos Ã  disposiÃ§Ã£o no salÃ£o da Tia. ðŸ’•`
    );

    window.open(`https://wa.me/55${raw}?text=${message}`, "_blank");
  }

  function openWhatsapp(apt) {
    const raw = normalizeWhatsapp(apt.whatsapp);
    if (!raw) {
      alert("WhatsApp invÃ¡lido ou nÃ£o informado.");
      return;
    }

    const message = encodeURIComponent(`OlÃ¡, ${apt.clientName}! Aqui Ã© do salÃ£o da Tia.`);
    window.open(`https://wa.me/55${raw}?text=${message}`, "_blank");
  }

  // ================== EVENTOS ==================
  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const clientName = document.getElementById("client-name").value.trim();
      const whatsapp   = document.getElementById("client-whatsapp").value.trim();
      const service    = document.getElementById("service").value;
      const date       = document.getElementById("date").value;
      const time       = document.getElementById("time").value;

      if (!clientName || !whatsapp || !service || !date || !time) {
        alert("Preencha todos os campos.");
        return;
      }

      const normalized = normalizeWhatsapp(whatsapp);
      if (!normalized) {
        alert("WhatsApp invÃ¡lido.");
        return;
      }

      if (!withinBusinessHours(time)) {
        alert("HorÃ¡rio fora do funcionamento (09hâ€“19h).");
        return;
      }

      const newAppointment = {
        id: Date.now().toString(),
        clientName,
        whatsapp,
        service,
        date,
        time,
        status: "pending",
        createdAt: new Date().toISOString()
      };

      try {
        await createAppointmentOnServer(newAppointment);
        await fetchAppointmentsFromServer();
        form.reset();
        alert("Pedido enviado! A confirmaÃ§Ã£o serÃ¡ feita via WhatsApp.");
      } catch (err) {
        console.error("Erro ao criar agendamento:", err);
        alert("Erro ao enviar o pedido. Tente novamente.");
      }
    });
  }

  if (statusFilter) {
    statusFilter.addEventListener("change", async (e) => {
      currentFilter = e.target.value;
      await fetchAppointmentsFromServer();
    });
  }

  // ================== INIT ==================
  (async function init() {
    const dateInput = document.getElementById("date");
    if (dateInput) {
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth() + 1).padStart(2, "0");
      const d = String(today.getDate()).padStart(2, "0");
      dateInput.min = `${y}-${m}-${d}`;
      dateInput.value = `${y}-${m}-${d}`;
    }

    await fetchAppointmentsFromServer();
  })();
</script>
